Mysql分表分库



### 分表

#### 水平分表

​	简单的水平切分主要是将某个访问极其频繁的大表再依照某个字段的某种规则来分散到多个表之中。每一个表中包括一部分数据。

简单来说，就是将表中的某些行切分到一个数据库（表），而另外的某些行又切分到其它的数据库（表）中。当然，为了能够比较容易的判定各行数据被切分到哪个数据库（表）中了，切分总是都须要依照某种特定的规则来进行的。

水平分库分表的切分规则主要包括如下几种：

1. 按号段分
    user_id为区分，1～1000的对应DB1，1001～2000的对应DB2，以此类推；
    优点：可部分迁移
    缺点：数据分布不均
2. hash取模分：
    对user_id进行hash，然后用一个特定的数字，比如应用中需要将一个数据库切分成4个数据库的话，我们就用4这个数字对user_id的hash值进行取模运算，也就是user_id%4，这样的话每次运算就有四种可能：结果为0的时候对应DB1；结果为1的时候对应DB2；结果为2的时候对应DB3；结果为3的时候对应DB4，这样一来就非常均匀的将数据分配到4个DB中。如上图所示。
    优点：数据分布均匀
    缺点：数据迁移的时候麻烦，不能按照机器性能分摊数据
3. 在认证库中保存数据库配置
    建立一个DB，这个DB单独保存user_id到DB的映射关系，每次访问数据库的时候都要先查询一次这个数据库，以得到具体的DB信息，然后才能进行我们需要的查询操作。
    优点：灵活性强，一对一关系
    缺点：每次查询之前都要多一次查询，性能大打折扣
4. 其他方式
    1）按照地理区域：比如按照华东，华南，华北这样来区分业务。
    2）按照时间切分，就是将6个月前，甚至一年前的数据切出去放到另外的一张表，因为随着时间流逝，这些表的数据被查询的概率变小，所以没必要和“热数据”放在一起，这个也是“冷热数据分离”。

以上就是通常的开发中我们选择的方式，有些复杂的项目中可能会混合使用这些方式。



##### 数据切分之后的问题解决

数据库中的数据在经过垂直和（或）水平切分被存放在不同的数据库（表）主机之后，应用系统面临的最大问题就是怎样来让这些数据源得到较好的整合，当然也包括切分的一个唯一性保障的问题。
 综合来说，主要有以下两个问题：

1. 保证ID全局唯一性。     ？？？？？
2. 查询数据结果集合并问题，这里包括跨节点Join的问题，跨节点合并排序分页问题以及分布式事务问题。